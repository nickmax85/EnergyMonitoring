<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title>EnergyMonitoring</title>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
    <!-- Google Font: Source Sans Pro -->
    <link
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700"
      rel="stylesheet"
    />

    <link href="css/custom.css" rel="stylesheet" />

    <script src="js/highcharts/8.0/highcharts.js"></script>
    <script src="js/highcharts/8.0/highcharts-more.js"></script>

    <script src="js/chartjs/2.9.3/Chart.min.js"></script>
    <script src="js/chartjs/2.9.3/utils.js"></script>
    <script src="js/chartjs/chartjs-plugin-zoom.min.js"></script>

    <script src="js/amcharts/core.js"></script>
    <script src="js/amcharts/charts.js"></script>
    <script src="js/amcharts/animated.js"></script>

    <script src="js/hammer/hammer.min.js"></script>

    <script src="js/moment/moment.min.js"></script>

    <script src="js/environment.js"></script>
    <script src="js/groups.js"></script>
    <script src="js/equipments.js"></script>
    <script src="js/constants.js"></script>
  </head>

  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="/index.html" class="nav-link">Home</a>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->
      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="/index.html" class="brand-link">
          <img
            src="img/wheel.gif"
            alt="Logo"
            class="brand-image img-circle elevation-3"
            style="opacity: 0.8"
          />
          <span class="brand-text font-weight-light">EnergyMonitoring</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <!-- Add icons to the links using the .nav-icon class
                        with font-awesome or any other icon font library -->
              <!-- Dashboard -->
              <li class="nav-item">
                <a href="dashboard.html" class="nav-link active">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>
                    Dashboard
                    <span class="right badge badge-danger"></span>
                  </p>
                </a>
              </li>

              <!-- Alarme -->
              <li class="nav-item">
                <a href="alarms.html" class="nav-link">
                  <i class="nav-icon fas fa-bell"></i>
                  <p>
                    Alarme
                    <span class="right badge badge-danger"></span>
                  </p>
                </a>
              </li>

              <!-- diagnosis -->
              <li class="nav-item">
                <a href="diagnosis.html" class="nav-link">
                  <i class="nav-icon fas fa-diagnoses"></i>
                  <p>
                    Diagnose
                    <span class="right badge badge-danger"></span>
                  </p>
                </a>
              </li>

              <!-- Konfiguration -->
              <li class="nav-item has-treeview menu">
                <a href="#" class="nav-link">
                  <i class="nav-icon fas fa-wrench"></i>
                  <p>
                    Konfiguration
                    <i class="right fas fa-angle-left"></i>
                  </p>
                </a>
                <!-- Sensoren -->
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="sensors.html" class="nav-link">
                      <i class="far fa-circle nav-icon"></i>
                      <p>Sensoren</p>
                    </a>
                  </li>
                </ul>
                <!-- Settings -->
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                      <i class="far fa-circle nav-icon"></i>
                      <p>Einstellungen</p>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </nav>
          <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0 text-dark">Dashboard</h1>
              </div>
              <!-- /.col -->
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item">
                    <a href="/index.html">Dashboard</a>
                  </li>
                  <li class="breadcrumb-item">Charts</li>
                  <li class="breadcrumb-item" id="group">Group</li>
                  <li class="breadcrumb-item active" id="equipment">
                    Equipment
                  </li>
                </ol>
              </div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->
        <!-- Main content -->
        <div class="content">
          <div class="container-fluid">
            <!-- Charts -->
            <div class="row">
              <div class="col-lg-9">
                <div class="card mb-3">
                  <div class="card-header">
                    <i class="fas fa-chart-area"></i>
                    Kennlinie:
                    <span id="datasize"></span>
                  </div>
                  <div class="card-body">
                    <div id="chartdiv"></div>
                    <!-- <canvas id="canvas" width="100%" height="50"></canvas> -->
                  </div>
                </div>
              </div>

              <div class="col-lg-3">
                <div class="card mb-3">
                  <div class="card-header">
                    <i class="fas fa-calendar-day"></i>
                    Datum
                  </div>
                  <div class="card-body">
                    <div class="form-group">
                      <!-- Date input -->
                      <div class="row">
                        <div class="col">
                          <label class="control-label" for="start">Start</label>
                          <input
                            type="date"
                            data-format="yyyy-MM-dd"
                            id="start"
                            class="form-control"
                            value="2019-12-01"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <!-- Date input -->
                      <div class="row">
                        <div class="col">
                          <label class="control-label" for="end">Ende</label>
                          <input
                            type="date"
                            data-format="yyyy-MM-dd"
                            id="end"
                            class="form-control"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <!-- Submit button -->
                      <button
                        class="btn btn-primary btn-block"
                        name="submit"
                        type="submit"
                        onclick="getRecords()"
                      >
                        Suche
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-lg-9">
                <div class="card mb-3">
                  <div class="card-header">
                    <i class="fas fa-chart-area"></i>
                    Durchschnittswerte
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-lg-4 col-6">
                        <!-- small card -->
                        <div class="small-box bg-gradient-primary">
                          <div class="inner">
                            <h3 id="pressureAvg">0 bar</h3>
                            <p>Druck</p>
                          </div>
                          <div class="icon">
                            <i class="fas fa-circle"></i>
                          </div>
                          <!--<a href="#" class="small-box-footer">
                                                    More info <i class="fas fa-arrow-circle-right"></i>
                                                </a>-->
                        </div>
                      </div>
                      <div class="col-lg-4 col-6">
                        <!-- small card -->
                        <div class="small-box bg-gradient-info">
                          <div class="inner">
                            <h3 id="flowAvg">0 l/min</h3>
                            <p>Durchfluss</p>
                          </div>
                          <div class="icon">
                            <i class="fas fa-gas-pump"></i>
                          </div>
                          <!--<a href="#" class="small-box-footer">
                                                    More info <i class="fas fa-arrow-circle-right"></i>
                                                </a>-->
                        </div>
                      </div>
                      <div class="col-lg-4 col-6">
                        <!-- small card -->
                        <div class="small-box bg-gradient-warning">
                          <div class="inner">
                            <h3 id="price">0 Euro/Jahr</h3>
                            <p>Kosten</p>
                          </div>
                          <div class="icon">
                            <i class="fas fa-coins"></i>
                          </div>
                          <!--<a href="#" class="small-box-footer">
                                                    More info <i class="fas fa-arrow-circle-right"></i>
                                                </a>-->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <div class="card card-outline card-info">
                  <div class="card-header">
                    <h3 class="card-title">Tätigkeiten</h3>
                    <!-- tools box -->
                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool btn-sm"
                        data-card-widget="collapse"
                        data-toggle="tooltip"
                        title="Collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                    </div>
                    <!-- /. tools -->
                  </div>
                  <!-- /.card-header -->

                  <div class="card-body">
                    <div class="row">
                      <a class="btn btn-app" id="newBtn">
                        <i class="fas fa-plus"></i> Neu
                      </a>
                    </div>
                    <div class="row">
                      <div class="col-md-12">
                        <div class="timeline" id="activities"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /.col-->
            </div>
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- /.content -->
      </div>
      <!-- /.content-wrapper -->
      <!-- Control Sidebar -->
      <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
        <div class="p-3">
          <h5>Title</h5>
          <p>Sidebar content</p>
        </div>
      </aside>
      <!-- /.control-sidebar -->
      <!-- Main Footer -->
      <footer class="main-footer">
        <!-- To the right -->
        <div class="float-right d-none d-sm-inline"></div>
        <!-- Default to the left -->
        <strong>Copyright &copy; 2019 <a>Markus Thaler</a>.</strong> All rights
        reserved.
      </footer>
    </div>
    <!-- ./wrapper -->
    <!-- REQUIRED SCRIPTS -->
    <!-- jQuery -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.min.js"></script>

    <script>
      let server = env.server;
      let config;
      let equipment;
      let sensors;

      let data1 = [];
      let data2 = [];
      let labels1 = [];
      let labels2 = [];

      const params = new URLSearchParams(window.location.search);

      for (let param of params) {
        document.writeln(`key: ${param[0]} Value: ${param[1]}`);
        //document.writeln(param);
      }

      let equipmentnumber = params.get("equipmentnumber");

      $(document).ready(function () {
        getConfig();
        getDate();

        if (equipmentnumber == null) {
          equipment = JSON.parse(sessionStorage.getItem("equipment"));
          show();
        } else {
          getEquipment(equipmentnumber);
        }

        $("#newBtn").click(function () {
          sessionStorage.setItem("equipment", JSON.stringify(equipment));
          sessionStorage.removeItem("activity");
          window.location.href = "activity.html";
        });
      });

      function getEquipment(equipmentnumber) {
        let url = server + "/api/equipments/" + equipmentnumber;

        $.getJSON(url)
          .done(function (data) {
            equipment = data;

            show();
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function show() {
        $("#group").html(equipment.Group.Name);
        $("#equipment").html(equipment.Number + " - " + equipment.Name);
        sensors = getSensors(equipment.Devices[0].DeviceID);
        getRecords();
        showFilterRecords();
        getActivities(equipment.EquipmentID);
      }

      function deleteActivity(activity) {
        let url = server + "/api/activities/delete/" + activity.ActivityID;
        dataType: "json",
          $.ajax({
            url: url,
            type: "DELETE",
          })
            .done(function (data) {
              getActivities(equipment.EquipmentID);
            })
            .fail(function (error) {
              alert("ERROR: " + error.status + " " + error.statusText);
            });
      }

      function getDate() {
        let today = new Date();

        let timeFormat = "YYYY-MM-DD";
        let now = window.moment();

        let start = now.clone().add(-1, "d").format(timeFormat);
        let end = now.format(timeFormat);

        //let start = today.getFullYear() + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + ('0' + today.getDate()).slice(-2);
        //let end = today.getFullYear() + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + ('0' + today.getDate()).slice(-2);

        $("#start").val(start);
        $("#end").val(end);
      }

      function getRecords() {
        let url =
          server +
          "/api/records/" +
          equipment.Devices[0].DeviceID +
          "/" +
          $("#start").val() +
          "/" +
          $("#end").val();

        $.getJSON(url)
          .done(function (data) {
            data1.length = 0;
            data2.length = 0;
            labels1.length = 0;
            labels2.length = 0;

            showData(data);

            // updateChart();
            showChart();
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });

        showFilterRecords();
      }

      function getSensors(deviceId) {
        let url = server + "/api/devices/" + deviceId + "/sensors";
        $.getJSON(url)
          .done(function (data) {
            sensors = data;
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function getActivities(equipmentId) {
        let url = server + "/api/activities/equipment/" + equipmentId;
        $.getJSON(url)
          .done(function (data) {
            showActivities(data);
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function showActivities(data) {
        let container = $("#activities");
        container.empty();

        if (!Array.isArray(data)) return;

        data.forEach(function (item, i) {
          let timeLabel = $('<div class="time-label">');
          let date = $('<span class="bg-success"></span>');
          date.html(item.Date.substring(0, 10));
          timeLabel.append(date);
          container.append(timeLabel);

          let div = $("<div>");
          container.append(div);

          let usericon = $('<i class="fas fa-user bg-green"></i>');
          div.append(usericon);
          let timelineItem = $('<div class="timeline-item">');
          div.append(timelineItem);

          let header = $(
            '<h3 class="timeline-header"><a href="#">Support Team</a> sent you an email</h3>'
          );
          header.html(item.ModifiedBy);
          timelineItem.append(header);

          let body = $('<div class="timeline-body">Testeintrag</div>');
          body.html(item.Comment);
          timelineItem.append(body);

          let footer = $('<div class="timeline-footer">');

          let btnEdit = $(
            '<a class="btn btn-primary btn-sm mr-2">Bearbeiten</a>'
          );
          btnEdit.val(item);
          btnEdit.click(function () {
            sessionStorage.setItem("equipment", JSON.stringify(equipment));
            sessionStorage.setItem("activity", JSON.stringify(item));
            window.location.href = "activity.html";
          });
          footer.append(btnEdit);

          let btnDelete = $(
            '<a class="btn btn-warning btn-sm mr-2" type="submit">Entfernen</a></div>'
          );
          btnDelete.val(item);
          btnDelete.click(function () {
            deleteActivity(btnDelete.val());
          });
          footer.append(btnDelete);

          timelineItem.append(footer);
        });
      }

      function getConfig() {
        let url = server + "/api/configs/Get";
        $.getJSON(url)
          .done(function (data) {
            config = data[0];
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function showFilterRecords() {
        $("#pressureAvg").html("0 bar");
        $("#flowAvg").html("0 l/min");

        let url =
          server +
          "/api/records/avg" +
          "/" +
          $("#start").val() +
          "/" +
          $("#end").val() +
          "/" +
          0 +
          "/" +
          equipment.EquipmentID;

        $.getJSON(url)
          .done(function (data) {
            if (typeof data[0] != "undefined")
              $("#pressureAvg").html(data[0].average + " bar");
            if (typeof data[1] != "undefined")
              $("#flowAvg").html(data[1].average + " l/min");
            if (typeof data[1] != "undefined")
              $("#price").html(
                Math.round(
                  data[1].average *
                    lMinInKubikMeterYear *
                    config.AirPressurePrice
                ) + " Euro/Jahr"
              );
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function showData(data) {
        if (!Array.isArray(data)) return;

        data.forEach(function (item, i) {
          if (item.SensorID == sensors[1].SensorID) {
            data1.push(item.Value);
            labels1.push(item.CreateDate);
          }

          if (item.SensorID == sensors[0].SensorID) {
            data2.push(item.Value);
            labels2.push(item.CreateDate);
          }
        });
      }

      function updateChart() {
        window.myLine.update();
      }

      var chartConfig = {
        type: "line",
        data: {
          labels: labels1,
          datasets: [
            {
              label: "Flow",
              yAxisID: "A",
              backgroundColor: window.chartColors.orange,
              borderColor: window.chartColors.orange,
              data: data1,
              fill: false,
            },
            {
              label: "Pressure",
              yAxisID: "B",
              fill: false,
              backgroundColor: window.chartColors.blue,
              borderColor: window.chartColors.blue,
              data: data2,
            },
          ],
        },
        options: {
          responsive: true,
          title: {
            display: false,
            text: "Chart.js Line Chart",
          },
          tooltips: {
            mode: "index",
            intersect: false,
          },
          hover: {
            mode: "nearest",
            intersect: true,
          },
          scales: {
            xAxes: [
              {
                display: false,
                scaleLabel: {
                  display: true,
                  labelString: "Zeitpunkt",
                },
              },
            ],
            yAxes: [
              {
                id: "A",
                display: true,
                scaleLabel: {
                  display: true,
                  labelString: "l/min",
                },
              },
              {
                id: "B",
                display: true,
                position: "right",
                ticks: {
                  max: 10,
                  min: 0,
                },
                scaleLabel: {
                  display: true,
                  labelString: "bar",
                },
              },
            ],
          },
          plugins: {
            zoom: {
              // Container for pan options
              pan: {
                // Boolean to enable panning
                enabled: true,

                // Panning directions. Remove the appropriate direction to disable
                // Eg. 'y' would only allow panning in the y direction
                mode: "xy",
              },

              // Container for zoom options
              zoom: {
                // Boolean to enable zooming
                enabled: true,

                // Zooming directions. Remove the appropriate direction to disable
                // Eg. 'y' would only allow zooming in the y direction
                mode: "xy",
              },
            },
          },
        },
      };

      window.onload = function () {
        return;
        var ctx = document.getElementById("canvas").getContext("2d");
        window.myLine = new Chart(ctx, chartConfig);
      };

      function showChart() {
        let datasize = $("#datasize").text(
          data1.length + data2.length + " Messwerte"
        );

        am4core.ready(function () {
          // Themes begin
          am4core.useTheme(am4themes_animated);
          // Themes end

          var chart = am4core.create("chartdiv", am4charts.XYChart);
          chart.colors.list = [
            am4core.color("blue"),
            am4core.color("FF9671"),
            am4core.color("green"),
            am4core.color("#FF9671"),
            am4core.color("#FFC75F"),
            am4core.color("#F9F871"),
          ];
          // Increase contrast by taking evey second color
          chart.colors.step = 2;

          var data = [];
          for (var i = 0; i < data1.length; i++) {
            var date = new Date(labels1[i]);

            data.push({
              date: date,
              value1: data1[i],
              value2: data2[i],
            });
          }

          chart.data = data;

          var interfaceColors = new am4core.InterfaceColorSet();

          // Create axes
          var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
          dateAxis.renderer.minGridDistance = 60;

          var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
          valueAxis.title.text = "l/min";
          valueAxis.syncWithAxis = chart.yAxes.getIndex(0);

          var valueAxis2 = chart.yAxes.push(new am4charts.ValueAxis());
          valueAxis2.title.text = "bar";
          valueAxis2.syncWithAxis = chart.yAxes.getIndex(0);

          // Create series
          var series = chart.series.push(new am4charts.LineSeries());
          series.dataFields.valueY = "value1";
          series.dataFields.dateX = "date";
          series.tooltipText =
            "{value1} l/min\n{date.formatDate('yyyy-MM-dd HH:mm:ss')}";
          series.yAxis = valueAxis;
          series.name = "Flow";
          series.tensionX = 0.8;
          series.showOnInit = true;

          series.tooltip.pointerOrientation = "vertical";

          // var bullet = series.bullets.push(new am4charts.CircleBullet());
          // bullet.circle.stroke = interfaceColors.getFor("background");
          // bullet.circle.strokeWidth = 2;

          var series2 = chart.series.push(new am4charts.LineSeries());
          series2.dataFields.valueY = "value2";
          series2.dataFields.dateX = "date";
          series2.tooltipText =
            "{value2} bar\n{date.formatDate('yyyy-MM-dd HH:mm:ss')}";
          series2.yAxis = valueAxis2;
          series2.name = "Pressure";
          series2.tensionX = 0.8;
          series2.showOnInit = true;

          series2.tooltip.pointerOrientation = "vertical";

          // var bullet = series2.bullets.push(new am4charts.Bullet());
          // bullet.width = 10;
          // bullet.height = 10;
          // bullet.horizontalCenter = "middle";
          // bullet.verticalCenter = "middle";

          // var rectangle = bullet.createChild(am4core.Rectangle);
          // rectangle.stroke = interfaceColors.getFor("background");
          // rectangle.strokeWidth = 2;
          // rectangle.width = 10;
          // rectangle.height = 10;

          // valueAxis.renderer.line.strokeOpacity = 1;
          // valueAxis.renderer.line.strokeWidth = 2;
          // valueAxis.renderer.line.stroke = series.stroke;
          // valueAxis.renderer.labels.template.fill = series.stroke;
          // valueAxis.renderer.opposite = true;

          // valueAxis2.renderer.line.strokeOpacity = 1;
          // valueAxis2.renderer.line.strokeWidth = 2;
          // valueAxis2.renderer.line.stroke = series2.stroke;
          // valueAxis2.renderer.labels.template.fill = series2.stroke;
          // valueAxis2.renderer.opposite = false;

          chart.legend = new am4charts.Legend();

          // Add cursor
          chart.cursor = new am4charts.XYCursor();

          chart.cursor = new am4charts.XYCursor();
          // chart.cursor.snapToSeries = series;
          chart.cursor.xAxis = dateAxis;

          //chart.scrollbarY = new am4core.Scrollbar();
          chart.scrollbarX = new am4core.Scrollbar();
          chart.scrollbarX.parent = chart.bottomAxesContainer;
        }); // end am4core.ready()
      }
    </script>
  </body>
</html>
