<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="css/custom.css" rel="stylesheet" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script src="js/environment.js"></script>

    <title>Equipments</title>
  </head>

  <body class="container">
    <h1>Equipments</h1>

    <h2>Equipment</h2>
    <form>
      <div class="form-row">
        <div class="form-group col-sm-1">
          <label for="id">Id</label>
          <input class="form-control form-control-sm" disabled id="id" />
        </div>
        <div class="form-group">
          <label for="number">Number</label>
          <input class="form-control form-control-sm" id="number" />
        </div>
        <div class="form-group">
          <label for="name">Name</label>
          <input class="form-control form-control-sm" id="name" />
        </div>
        <div class="form-group">
          <label for="group">Group</label>
          <input class="form-control form-control-sm" id="group" />
        </div>
        <div class="form-group">
          <label>InactiveDate</label>
          <input
            class="form-control form-control-sm"
            id="inactiveDate"
            type="date"
          />
        </div>
        <div class="form-check">
          <label for="active">Active</label>
          <br />
          <input type="checkbox" id="active" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>CreateDate</label>
          <input
            class="form-control form-control-sm"
            id="createDate"
            type="date"
          />
        </div>
        <div class="form-group">
          <label>UpdateDate</label>
          <input
            disabled
            class="form-control form-control-sm"
            id="updateDate"
            type="date"
          />
        </div>
      </div>
    </form>
    <button class="btn btn-success" id="newButton">New</button>
    <button type="submit" class="btn btn-primary" id="saveButton">Save</button>

    <br />

    <h2>List</h2>
    <ul id="groups" class="list-group"></ul>

    <script>
      let server = env.server;

      let equipment;

      $(document).ready(function () {
        getEquipments();

        $("#newButton").click(function () {
          equipment = new Object();
          equipment.EquipmentID = 0;
          equipment.Active = true;
          showData();
        });

        $("#saveButton").click(function () {
          if (equipment.EquipmentID == 0) postEquipment();
          else putEquimpment();
        });
      });

      function getEquipments() {
        let url = server + "/api/Equipments/GetEquipment";

        $.getJSON(url)
          .done(function (data) {
            showList(data);
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function postEquipment() {
        equipment.EquipmentID = $("#id").val();
        equipment.Number = $("#number").val();
        equipment.Name = $("#name").val();
        equipment.Active = $("#active").prop("checked");
        equipment.InactiveDate = $("#inactiveDate").val();
        equipment.GroupID = $("#group").val();
        equipment.CreateDate = $("#createDate").val();
        equipment.UpdateDate = $("#updateDate").val();

        let url = server + "/api/equipments/PostEquipment";

        $.post(url, equipment)
          .done(function (data) {
            equipment = null;
            showData();
            getEquipments();
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function putEquimpment() {
        equipment.EquipmentID = $("#id").val();
        equipment.Number = $("#number").val();
        equipment.Name = $("#name").val();
        equipment.Active = $("#active").prop("checked");
        equipment.InactiveDate = $("#inactiveDate").val();
        equipment.GroupID = $("#group").val();
        equipment.CreateDate = $("#createDate").val();
        equipment.UpdateDate = $("#updateDate").val();

        let url =
          server + "/api/equipments/PutEquipment/" + equipment.EquipmentID;

        $.ajax({
          url: url,
          type: "PUT",
          contentType: "application/json;charset=utf-8",
          data: JSON.stringify(equipment),
          success: function (equipment) {
            alert("Daten erfolgreich gespeichert.");
            getEquipments();
          },
          error: function (request, message, error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          },
        });
      }

      function deleteEquipment(id) {
        let url = server + "/api/equipments/DeleteEquipment/" + id;

        $.ajax({
          url: url,
          type: "DELETE",
        })
          .done(function (data) {
            alert("Daten wurden entfernt");
            getEquipments();
          })
          .fail(function (error) {
            alert("ERROR: " + error.status + " " + error.statusText);
          });
      }

      function showData() {
        if (equipment == null) {
          $("#id").val(null);
          $("#number").val(null);
          $("#name").val(null);
          $("#active").prop("checked", true);
          $("#inactiveDate").val(null);
          $("#group").val(null);
          $("#createDate").val(null);
          $("#updateDate").val(null);
        } else {
          $("#id").val(equipment.EquipmentID);
          $("#number").val(equipment.Number);
          $("#name").val(equipment.Name);
          if (equipment.Active) $("#active").prop("checked", true);
          else $("#active").prop("checked", false);

          if (equipment.InactiveDate != null)
            $("#inactiveDate").val(formatDate(equipment.InactiveDate));
          else $("#inactiveDate").val(null);

          $("#group").val(equipment.GroupID);
          $("#createDate").val(formatDate(equipment.CreateDate));
          $("#updateDate").val(formatDate(equipment.UpdateDate));
        }
      }

      function showList(data) {
        let container = $("#groups");
        container.empty();

        if (!Array.isArray(data)) return;

        data.forEach(function (item, i) {
          let li = $('<li class="list-group-item">');

          let label = $("<label>").html(
            item.Number + " - " + item.Name + " [active=" + item.Active + "]"
          );

          let editButton = $(
            '<button type="submit" class="btn-sm btn-warning" style="margin:5px;"">'
          ).attr("equipment", JSON.stringify(item));
          editButton.html("Edit");
          editButton.click(function () {
            let item = $(this).attr("equipment");
            equipment = JSON.parse(item);
            showData();
          });

          let deleteButton = $(
            '<button type="submit" class="btn-sm btn-danger">'
          ).attr("equipment", JSON.stringify(item));
          deleteButton.html("Delete");
          deleteButton.click(function () {
            let item = $(this).attr("equipment");
            equipment = JSON.parse(item);
            deleteEquipment(equipment.EquipmentID);
          });

          li.append(label);
          li.append(editButton);
          li.append(deleteButton);

          container.append(li);
        });
      }
    </script>
  </body>
</html>
