<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="plugins/fontawesome-free/css/all.min.css" rel="stylesheet">

    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css">

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <link href="css/custom.css" rel="stylesheet" />
</head>
<body class="container">

    <div class="col-md-9 col-sm-12">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">Sensor</h3>
            </div>
            <!-- /.card-header -->
            <!-- form start -->
            <form role="form">
                <div class="card-body">
                    <div class="form-group">
                        <label for="lowerLimit">Untergrenze</label><br>
                        <input id="lowerLimit" type="text" pattern="[-+]?[0-9]*[.]?[0-9]+" style="width: 50px; text-align:right;" />
                        <label id="sign1" style="font-weight: normal"></label>
                    </div>
                    <div class="form-group">
                        <label for="upperLimit">Obergrenze</label><br>
                        <input id="upperLimit" type="text" pattern="[-+]?[0-9]*[.]?[0-9]+" style="width: 50px; text-align:right;" />
                        <label id="sign2" style="font-weight: normal"></label>
                    </div>
                    <div class="form-group">
                        <label for="selectUnit">Einheit</label>
                        <select class="form-control" id="selectUnit" onchange="changeUnitOnClick(this)">
                            <option>auswählen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="selectDevice">Device</label>
                        <select class="form-control" id="selectDevice">
                            <option>auswählen</option>
                        </select>
                    </div>
                </div>
                <!-- /.card-body -->

                <div class="card-footer">
                    <button type="submit" class="btn bg-gradient-success btn-flat" id="addButton" disabled>
                        <i class="fas fa-folder-plus"></i>
                        Neu
                    </button>
                    <button type="submit" class="btn bg-gradient-warning btn-flat" id="saveButton">
                        <i class="fas fa-save"></i>
                        Speichern
                    </button>

                    <button type="button" class="btn bg-gradient-primary btn-flat" id="refreshButton">
                        <i class="fas fa-sync"></i>
                        Aktualisieren
                    </button>
                </div>
            </form>
        </div>

    </div>
    <script>

        let item;
        let sensor;

        $(document).ready(function () {

            let item = JSON.parse(localStorage.getItem('sensor'));

            getSensor(item.SensorID);


            $('#refreshButton').click(function () {

                getSensor(item.SensorID);

            });

            $('#saveButton').click(function () {

                saveSensor();
            });

        });



        function getSensor(SensorID) {

            let url = '/api/Sensors/' + SensorID;

            $.getJSON(url)
                .done(function (data) {

                    $('#lowerLimit').val(data.LowerLimit.toFixed(1));
                    $('#upperLimit').val(data.UpperLimit.toFixed(1));
                    sensor = data;

                    getUnits(data);
                    getDevices(data);
                })
                .fail(function (error) {
                    alert("ERROR: " + error.status + ' ' + error.statusText);
                });

        }

        function getUnits(data) {

            let url = '/api/units';

            $.getJSON(url)
                .done(function (data) {

                    showUnits(data);

                })
                .fail(function (error) {
                    alert("ERROR: " + error.status + ' ' + error.statusText);
                });

        }

        function getDevices() {

            let url = '/api/devices';

            $.getJSON(url)
                .done(function (data) {

                    showDevices(data);
                })
                .fail(function (error) {
                    alert("ERROR: " + error.status + ' ' + error.statusText);
                });

        }

        function showUnits(data) {

            let container = $('#selectUnit');
            container.empty();

            if (!Array.isArray(data))
                return;

            data.forEach(function (item, i) {

                $('#selectUnit').append($('<option></option>')
                    .val(item.UnitID)
                    .html(item.Name + ' [' + item.Sign + ']')
                    .attr('unit', JSON.stringify(item)));

            });

            $('#selectUnit').val(sensor.UnitID);

            let attr = $("#selectUnit option:selected").attr('unit');

            if ($("#selectUnit").prop('selectedIndex') != 0) {
                $("#sign1").text(JSON.parse(attr).Sign);
                $("#sign2").text(JSON.parse(attr).Sign);
            }

        }

        function showDevices(data) {

            let container = $('#selectDevice');
            container.empty();

            if (!Array.isArray(data))
                return;

            data.forEach(function (item, i) {

                $('#selectDevice').append($('<option></option>').val(item.DeviceID).html(item.Name + '  [' + item.IP + ']'));

            });
            $('#selectDevice').val(sensor.DeviceID);
        }

        function changeUnitOnClick() {

            let sel = $("#selectUnit option:selected").val();
            let attr = $("#selectUnit option:selected").attr('unit');

            if ($("#selectUnit").prop('selectedIndex') != 0) {

                $("#sign1").text(JSON.parse(attr).Sign);
                $("#sign2").text(JSON.parse(attr).Sign);
            }

        }


        function saveSensor() {

            if (!validateInput())
                return;

            let item = JSON.parse(localStorage.getItem('sensor'));
            let url = '/api/sensors/' + item.SensorID;

            Sensor = new Object();
            Sensor.LowerLimit = $('#lowerLimit').val();
            Sensor.UpperLimit = $('#upperLimit').val();
            Sensor.UnitID = $('#selectUnit').val();
            Sensor.DeviceID = $('#selectDevice').val();

            $.ajax({
                url: url,
                type: 'PUT',
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(Sensor),
                success: function (product) {

                },
                error: function (request, message, error) {
                    alert("ERROR: " + error.status + ' ' + error.statusText);
                }
            });
        }

        function validateInput() {

            console.log(isNaN($('#lowerLimit').val()));

            if (isNaN($('#lowerLimit').val()))
                return false;

            if (isNaN($('#lowerLimit').val()))
                return false;

            return true;

        }

    </script>

</body>
</html>